generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Appointment {
  id              String   @id @default(cuid())
  customerName    String
  customerPhone   String
  haircutType     String
  notes           String?
  startTime       DateTime
  durationMinutes Int      @default(60)
  status          AppointmentStatus @default(SCHEDULED)
  cancelledAt     DateTime?
  cancelledByRole CancelledByRole?
  cancelReason    String?
  // Pagamentos
  paymentMethod   String?  // cartao | pix | dinheiro
  paymentStatus   String?  // pending | approved | rejected
  mpPaymentId     String?  @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status, startTime])
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CANCELLED
}

enum CancelledByRole {
  BARBER
}

model BlockedSlot {
  id        String   @id @default(cuid())
  startTime DateTime @unique
  reason    String?
  createdAt DateTime @default(now())
}

model WebhookEvent {
  id                      String                   @id @default(cuid())
  provider                WebhookProvider
  requestId               String                   @unique
  receivedAt              DateTime                 @default(now())
  method                  String
  path                    String
  query                   Json
  headers                 Json
  body                    Json
  eventType               String
  eventAction             String
  relatedProviderPaymentId String?
  processedAt             DateTime?
  processingStatus        WebhookProcessingStatus  @default(FAILED)
  errorMessage            String?

  @@index([provider, receivedAt])
  @@index([relatedProviderPaymentId])
  @@unique([provider, relatedProviderPaymentId, eventAction])
}

enum WebhookProvider {
  MERCADOPAGO
}

enum WebhookProcessingStatus {
  SUCCESS
  FAILED
  IGNORED
}
